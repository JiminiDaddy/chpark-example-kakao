## KakaoPay 뿌리기 기능 구현

## 문제해결 전략
### 기능 최소화
~~개발 첫날 채팅방, 사용자 관리까지 함께 구현을 진행하려고 했으나 프로그램이 복잡해지고 요구사항에 채팅방과 사용자 관리에 대해선 언급이 없기때문에 제거함~~  
뿌리기 Entity에서 채팅방과 사용자 Entity와의 연관 관계를 없애고 Key(String, Long)을 저장하는 방식으로 구현

```java
// before
public Class MoneyThrowing {
  ...
  private Room room;
  private Member sender;
  ...
}
// after
public Class MoneyThrowing {
  ...
  private String roomId;
  private Long senderId;
  ...
}
```

AccessToken은 중복되지 않는 임의의 3자리 문자열이므로 가장 간단한 방법으로 UUID를 통해 3자리를 만들고, 만든 Token이 기존에 저장된 값이 포함되지 않을때까지 다시 생성하는 방식으로 진행

<hr/>

### 설계
뿌리기 도메인에서 받기/조회하기 기능을 수행할 때, 유효 체크(Token, Room, Member, Time 등등)에 따라 에러코드를 생성함으로써 성공/실패 여부를 서비스 영역으로 전가하지 않도록 구현함  

AccessToken 유효체크는 비즈니스 로직이므로 서비스 영역에서 처리함으로써, 표현 영역에서는 서비스에서 발생한 예외에 따른 예외처리만 진행하도록 구현함  

RoomId와 UserId의 유효성 체크(Null check)는 표현 영역에서 처리함으로써, 잘못된 값이 비즈니스 로직으로 넘어가지 않도록 구현함  

<hr/>

### 테스트  
Junit5를 사용했고, 단위 테스트로는 Controller API Test를 진행했고 통합 테스트로는 각 기능 및 제약사항에 대해 진행함  

통합 테스트 후에는 Postman으로 각 기능별 응답코드를 확인하면서 기능 테스트를 진행함  


<hr/>


## 기능  
### 뿌리기  
현재 입장중인 채팅방 및 사용자 정보를 갖고있는 클라이언트가 /api/v1/money-throw URL에 Post로 요청한다.  

채팅방 및 사용자 정보 유효성 체크 후 현재 입장중인 채팅방의 고유 토큰을 생성하여 클라이언트로 반환한다.  

이후 토큰을 수신받은 사용자는 7일간 본인이 뿌린 현황 조회 가능하다.  

단, 사용자 자신은 받기가 불가능하다.  

<hr/>

### 받기  
채팅방에 뿌리기가 발생되면 채팅방의 다른 멤버들이 해당 API(/api/v1/money-throw/{accessToken})를 호출하여 받기 요청한다.  

채팅방, 사용자, 토큰의 유효성 체크 후 다음과 같은 로직을 순행한다.  
1. 요청한 토큰의 채팅방 고유값이 현재 입장중인 채팅방의 고유값과 같은가?  
2. 요청한 사용자가 뿌린 사용자는 아닌가?  
3. 이미 받기를 수행한 사용자가 아닌가?  
4. 받기 유효시간(10분)이 경과하진 않았는가?  

모든 검증이 정상적으로 끝났다면 요청한 사용자는 일정 금액을 받게되며 아래와 같은 정보를 수신한다.  
1. 받은 금액  

만약 검증이 실패되면 적절한 에러코드가 발생되며 클라이언트의 응답코드로 전달된다.  

<hr/>

### 조회하기  
뿌린 사용자는 7일간 뿌리기 현황 조회가 가능하다.  

채팅방, 사용자, 토큰의 유효성 체크 후 다음과 같은 로직을 순행한다.  
1. 요청한 토큰의 채팅방 고유값이 현재 입장중인 채팅방의 고유값과 일치하는가?  
2. 요청한 사용자가 뿌린 사용자와 일치하는가?  
3. 조회 유효시간(7일)이 경과하진 않았는가?  

모든 검증이 정상적으로 끝났다면 요청한 사용자는 응답코드를 통해 다음과 같은 정보를 수신한다.  
1. 뿌린 시각  
2. 뿌린 금액  
3. 받기 완료된 금액 (멤버들이 받아간 금액의 총합)  
4. 받은 멤버들의 정보(멤버 고유값, 받은 금액) 리스트  

<hr/>

### 공통  
모든 응답에는 응답코드 및 응답메시지가 전달된다.  

응답코드  
100 : 정상  
110 : 토큰 오류  
120 : 채팅방 유효 검증 실패  
130 : 사용자 유효 검증 실패 (뿌린이가 아닌 사용자가 조회 시도한 경우)  
131 : 받기 불가능 사용자 (이미 수신받은 사용자)  
132 : 받기 불가능 사용자 (뿌린이가 받기 시도한 경우)  
140 : 최대 받을 수 있는 사용자 수 초과  
150 : 조회 가능시간 초과  
151 : 받기 가능시간 초과  
